<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Single-File Editor</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Dancing+Script&family=Lato&family=Merriweather&family=Montserrat&family=Noto+Sans&family=Open+Sans&family=Oswald&family=Pacifico&family=Playfair+Display&family=Poppins&family=Raleway&family=Roboto&family=Roboto+Mono&family=Source+Sans+Pro&family=Ubuntu&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --accent: #22c55e;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --border: #334155;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; background: var(--bg); color: var(--text); }
    header { display:flex; align-items:center; justify-content:space-between; padding: 12px 16px; border-bottom: 1px solid var(--border); background: #0b1220; position: sticky; top: 0; z-index: 10; }
    header h1 { margin: 0; font-size: 18px; letter-spacing: 0.3px; }
    .toolbar { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    .toolbar-group { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    .toolbar select, .toolbar input[type="number"], .toolbar input[type="text"], .toolbar button, .toolbar label {
      background: var(--panel); color: var(--text); border: 1px solid var(--border); border-radius: 6px; padding: 8px 10px; font-size: 14px;
    }
    .toolbar button { cursor: pointer; }
    .toolbar button.primary { background: var(--accent); color: #052814; border: none; font-weight: 600; }
    .toolbar button:disabled { opacity: 0.6; cursor: not-allowed; }
    .toolbar .sep { width:1px; height:28px; background: var(--border); margin: 0 4px; }

    main { display:grid; grid-template-columns: 1fr; gap: 12px; padding: 12px; }
    .controls { display:flex; flex-direction:column; gap:8px; }

  .canvas-wrap { background: #f0f0f0; border:1px solid var(--border); border-radius: 10px; display:flex; align-items:center; justify-content:center; min-height: 70vh; position: relative; overflow:auto; }
  /* Fix: Do not set background on 'canvas' tag directly, as Fabric.js creates an upper canvas overlay that must remain transparent. */
  .canvas-container { background: #ffffff; box-shadow: 0 0 0 1px var(--border) inset; }

    footer { padding: 12px 16px; border-top: 1px solid var(--border); color: var(--muted); }
    .hint { color: var(--muted); font-size: 12px; }
    a.link { color: #93c5fd; text-decoration: none; }
  </style>
    <script src="https://cdn.jsdelivr.net/npm/fabric@4.6.0/dist/fabric.min.js"></script>
</head>
<body>
  <header>
    <div class="toolbar">
            <div id="toolbar-main" class="toolbar-group">
        <label>
          Item:
          <select id="bgSelect">
            <option value="">None</option>
            <option value="w_pen.png">Wooden Pen</option>
            <option value="cuttlery.png">Cuttlery</option>
            <option value="tumbler.png">Tumbler</option>
            <option value="mug.png">Mug</option>
            <option value="notebook.png">Notebook</option>
            <option value="kc_round.png">Keychain-Round</option>
            <option value="kc_rect.png">Keychain-Rectangle</option>
          </select>
        </label>

        <button id="addTextBtn">Add Text</button>

        <input id="imageInput" type="file" accept="image/*" style="display:none" />
        <button id="insertImageBtn">Insert Image</button>

        <button id="deleteBtn" title="Delete Selected">Delete</button>
        <button id="bringForwardBtn" title="Bring Forward">↑</button>
        <button id="sendBackwardsBtn" title="Send Backward">↓</button>

        <button id="exportBtn" class="primary">PNG</button>
        <button id="exportSvgBtn">SVG</button>
        <button id="emailBtn">Email</button>
      </div>

            <div id="toolbar-text" class="toolbar-group" style="display:none; border-left: 1px solid var(--border); padding-left: 8px;">
        <select id="fontFamily">
          <option value="Roboto">Roboto</option>
          <option value="Open Sans">Open Sans</option>
          <option value="Lato">Lato</option>
          <option value="Montserrat">Montserrat</option>
          <option value="Oswald">Oswald</option>
          <option value="Merriweather">Merriweather</option>
          <option value="Playfair Display">Playfair Display</option>
          <option value="Dancing Script">Dancing Script</option>
          <option value="Pacifico">Pacifico</option>
          <option value="Poppins">Poppins</option>
          <option value="Raleway">Raleway</option>
          <option value="Noto Sans">Noto Sans</option>
          <option value="Source Sans Pro">Source Sans Pro</option>
          <option value="Ubuntu">Ubuntu</option>
          <option value="Arial">Arial</option>
        </select>
        <button id="loadFontsBtn" title="Load local system fonts">Local</button>
        
        <input id="googleFontInput" type="text" placeholder="Google Font" style="width: 100px;" />
        <button id="loadGoogleFontBtn">Get</button>
        
        <input id="fontSize" type="number" min="8" max="200" step="1" value="32" style="width: 60px;" />
        <button id="boldBtn"><strong>B</strong></button>
        <button id="italicBtn"><em>I</em></button>
      </div>

            <div id="toolbar-image" class="toolbar-group" style="display:none; border-left: 1px solid var(--border); padding-left: 8px;">
        <button id="invertBtn" title="Invert Colors">Invert</button>
      </div>
    </div>
  </header>

  <main>
        <section class="canvas-wrap">
      <canvas id="c" width="1024" height="1024"></canvas>
    </section>
  </main>

  <footer>
    Export downloads a PNG locally. Email opens your mail client with a prefilled message. To auto-send emails, you need a small backend; see notes below.
  </footer>

  <script>
    // Defer initialization until window load to ensure scripts and DOM are ready
    window.addEventListener('load', () => {
      // Guard: ensure Fabric.js loaded
      if (typeof fabric === 'undefined') {
        alert('Fabric.js failed to load. Please check your internet connection or use a local server.');
        return;
      }

      // Customize Fabric selection controls (Thicker lines, larger handles for mobile)
      fabric.Object.prototype.set({
        transparentCorners: false,
        cornerColor: '#ffffff',
        cornerStrokeColor: '#22c55e', // Accent color
        borderColor: '#22c55e',
        cornerSize: 40,        // Even larger handles
        padding: 15,           // More space around object
        cornerStyle: 'circle', // Modern rounded corners
        borderScaleFactor: 4,  // Thicker border line
        rotatingPointOffset: 300 // UPDATED: Changed from 150 to 300 for a longer stem
      });

      // Initialize Fabric canvas
      const canvas = new fabric.Canvas('c', {
        backgroundColor: '#ffffff',
        preserveObjectStacking: true,
        selection: false, // Disable group selection to allow panning
        enableRetinaScaling: false,
        width: 1024, // Explicit width
        height: 1024 // Explicit height (Square)
      });
      
      // Force a render immediately to ensure canvas is ready
      canvas.renderAll();

      // Limit rotation to 15 degree steps
      canvas.on('object:rotating', (e) => {
        e.target.angle = Math.round(e.target.angle / 15) * 15;
      });

      // Dynamic Rotation Stem: Set length to 1/2 the longer side of the object
      function adjustRotationStem(e) {
          const obj = e.target;
          if (!obj) return;
          const dim = Math.max(obj.getScaledWidth(), obj.getScaledHeight());
          // Set stem to 1/2 longer side, but keep a minimum of 120px for touch usability
          obj.set('rotatingPointOffset', Math.max(120, dim / 2)); // UPDATED: Min changed from 60 to 120
      }
      canvas.on('selection:created', adjustRotationStem);
      canvas.on('selection:updated', adjustRotationStem);
      canvas.on('object:scaling', adjustRotationStem);

      // Panning Logic (Mouse/Touch Drag on background)
      let isDragging = false;
      let lastPosX;
      let lastPosY;

      // Smart Selection Bias: Track last active object to prevent accidental panning
      let lastSelected = null;
      canvas.on('selection:created', (e) => lastSelected = e.target);
      canvas.on('selection:updated', (e) => lastSelected = e.target);
      canvas.on('object:removed', (e) => {
          if (e.target === lastSelected) lastSelected = null;
      });

      canvas.on('mouse:down', function(opt) {
        const evt = opt.e;
        // If user clicks an object, don't pan
        if (opt.target) {
            lastSelected = opt.target;
            return;
        }
        
        // Bias: If clicking near the previously selected object, re-select it and don't pan
        if (lastSelected && canvas.getObjects().includes(lastSelected)) {
            const pointer = canvas.getPointer(evt);
            const bound = lastSelected.getBoundingRect();
            const pad = 60; // 60px buffer around object
            
            if (pointer.x >= bound.left - pad &&
                pointer.x <= bound.left + bound.width + pad &&
                pointer.y >= bound.top - pad &&
                pointer.y <= bound.top + bound.height + pad) {
                
                // Restore selection if lost
                if (!canvas.getActiveObject()) {
                    canvas.setActiveObject(lastSelected);
                    canvas.requestRenderAll
